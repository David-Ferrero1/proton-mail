
ServerAdmin root@localhost
ServerName localhost

# Values from VHost Macro
Define hostname localhost
Define hostversion default
Define domain localhost
Define escapedhost '%6C%6F%63%61%6C%68%6F%73%74'

# Code below copied from https://gitlab.protontech.ch/ProtonMail/Slim-API/-/tree/develop/scripts%2Fdocker%2Fetc%2Fhttpd%2Fconf
<VirtualHost *:443>
  ServerAdmin root@localhost
  ServerName localhost
  DocumentRoot "/usr/local/apache2/htdocs"

  # This is required to allow ErrorDocument 404 .htaccess directives to work for URLs with %2f in them
  # Example vulnerability: https://example.com/We%20are%20moved%20to%20URL:%20www.evil.com%2f
  AllowEncodedSlashes NoDecode

  # TODO: consider whether to log to file or stdout+stderr
  # ErrorLog /var/log/httpd/$hostname-error.log

  # NCSA combined with extras
  LogFormat "%a %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\" %{X-Client-Port}i %D %{X-PM-Request-ID}i %{X-PM-Session-ID}i %{X-PM-Version}i %{X-PM-Appversion}i \"%{X-PM-Route-Pattern}o\" %{X-PM-User-ID}o %{X-PM-UID}o %{X-PM-Code}o %{X-PM-Code-Actual}o \"%r\" %>s %{X-PM-Memory}o %{X-PM-Time-Total}o %{X-PM-Time-User}o %{X-PM-Time-System}o" default
  LogFormat "%a %l %u %t \"%{X-PM-HTTP-Method}o %{X-PM-HTTP-URI}o %{X-PM-HTTP-Protocol}o\" %{X-PM-HTTP-Status}o %b \"%{Referer}i\" \"%{User-agent}i\" %{X-Client-Port}i %D %{X-PM-Request-ID}i %{X-PM-Session-ID}i %{X-PM-Version}i %{X-PM-Appversion}i \"%{X-PM-Route-Pattern}o\" %{X-PM-User-ID}o %{X-PM-UID}o %{X-PM-Code}o %{X-PM-Code-Actual}o \"%r\" %>s %{X-PM-Memory}o %{X-PM-Time-Total}o %{X-PM-Time-User}o %{X-PM-Time-System}o" tunnel

  SetEnvIfExpr "'%{REQUEST_METHOD} %{REQUEST_URI}' =~ m#^POST (/api)?/tunnel#i" tunnel
  CustomLog /var/log/httpd/$hostname-access.log default env=!tunnel
  CustomLog /var/log/httpd/$hostname-access.log tunnel env=tunnel

  # Request ID header
  RequestHeader set X-PM-Request-ID "%{UNIQUE_ID}e"

  # Nonce
  RequestHeader set X-PM-Nonce "%{UNIQUE_ID}e"
  RequestHeader edit* X-PM-Nonce @ +
  RequestHeader edit* X-PM-Nonce - /
  Header echo X-PM-Nonce

  # Session header and cookie (parent domain)
  SetEnvIf Cookie "(?:^|; )Session-Id=([a-zA-Z0-9@-]+)" id=$1
  RequestHeader set X-PM-Session-ID "%{id}e" env=id
  Header add Set-Cookie "Session-Id=%{id}e; Domain=$domain; Path=/; HttpOnly; Secure; Max-Age=7776000" env=id
  Header add Set-Cookie "Session-Id=%{UNIQUE_ID}e; Domain=$domain; Path=/; HttpOnly; Secure; Max-Age=7776000" env=!id

  # Get version from header if present
  SetEnvIf Host .+ version=${hostversion}
  SetEnvIf X-PM-Version "^([a-zA-Z0-9]+)$" version=$1

  # Overwrite version header and set version cookie, host cookie (no domain attribute)
  RequestHeader set X-PM-Version "%{version}e"
  Header add Set-Cookie "Version=%{version}e; Path=/; Secure; Max-Age=7776000"

  # Kill legacy parent version domain cookie
  Header add Set-Cookie "Version=; Domain=$domain; Path=/; Secure; Expires=Thu, 01 Jan 1970 00:00:00 GMT"

  # Phishing detection
  AddOutputFilterByType SUBSTITUTE text/css #application/javascript application/x-javascript text/javascript
  # SubstituteMaxLineLength 10M
  Substitute "s|([\"'])[^\"']*/assets/host\.png([\"'])|$1https://$hostname/assets/host.png$2|iq"

  AddOutputFilterByType SUBSTITUTE text/css #application/javascript application/x-javascript text/javascript
  # SubstituteMaxLineLength 10M
  Substitute "s|([\"'])[^\"']*/%61%73%73%65%74%73/%68%6f%73%74%2e%70%6e%67([\"'])|$1https://$escapedhost/%61%73%73%65%74%73/%68%6f%73%74%2e%70%6e%67$2|iq"

  SetEnvIf Request_URI /assets/host.png$ hostimage=yes
  SetEnvIf Referer .+ crossorigin=yes
  SetEnvIf Referer ^https://$hostname !crossorigin
  CustomLog /var/log/httpd/phishing_trap.log "%t %{Host}i %a %{Referer}i \"%{User-Agent}i\"" expr=(reqenv('hostimage')=='yes'&&reqenv('crossorigin')=='yes')

  # TODO: double check what the RewriteRule command below is for, then adapt or delete it
  # RewriteCond /var/www/sites/$hostname/%{ENV:version} -x
  # RewriteCond %{REQUEST_URI} !^/api($|/)
  # RewriteRule ^/?(.*) /%{ENV:version}/$1 [L]

  # Cypress integrity bug workaround https://github.com/cypress-io/cypress/issues/2393
  <If "! -z req('X-PM-Cypress')">
    AddOutputFilterByType SUBSTITUTE text/html
    Substitute 's/(\s)(integrity=[^\s]?sha)/$1cypress:stripped-$2/iq'
  </If>

  # https://httpd.apache.org/docs/current/mod/mod_proxy.html
  SSLProxyEngine On

  <Location "/api/">
    ProxyPass ${API_ENDPOINT}
    ProxyPassReverse ${API_ENDPOINT}
  </Location>

  <Location "/calendar">
    ProxyPass ${CALENDAR_ENDPOINT}
    ProxyPassReverse ${CALENDAR_ENDPOINT}
  </Location>

  <Location "/contacts">
    ProxyPass ${CONTACTS_ENDPOINT}
    ProxyPassReverse ${CONTACTS_ENDPOINT}
  </Location>

  <Location "/settings">
    ProxyPass ${SETTINGS_ENDPOINT}
    ProxyPassReverse ${SETTINGS_ENDPOINT}
  </Location>

  <Directory "/usr/local/apache2/htdocs">
    # AllowOverride controls what directives may be placed in .htaccess files.
    AllowOverride All
  </Directory>
</VirtualHost>
